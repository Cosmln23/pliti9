"use strict";(()=>{var e={};e.id=1277,e.ids=[1277],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},98346:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>h,originalPathname:()=>E,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>g});var i={};s.r(i),s.d(i,{GET:()=>d,POST:()=>l});var r=s(95419),a=s(69108),o=s(99678),n=s(78070),c=s(24522),u=s(6454);async function l(e){try{let{session_id:t,location:s,playback_url:i,estimated_duration:r,started_at:a,stream_source:o="mobile"}=await e.json();if(!t||!s||!i)return n.Z.json({error:"Date incomplete",message:"session_id, location È™i playback_url sunt obligatorii"},{status:400});console.log("\uD83D\uDEA8 Live session started webhook triggered:",t);let l=await (0,c.en)();if(console.log(`ðŸ“Š Found ${l.length} active access codes for notification`),0===l.length)return n.Z.json({success:!0,message:"Live session started but no active users to notify",session:{session_id:t,location:s,playback_url:i,started_at:a||new Date().toISOString()},notifications:{active_codes:0,emails_sent:0,whatsapp_sent:0,make_automation_triggered:!1}});let d={sessionId:t,playbackUrl:i,startTime:a||new Date().toISOString(),location:s,estimatedDuration:r||120,source:o,activeCodesCount:l.length};console.log("\uD83D\uDCE7 Triggering Make.com mass notifications...");let _=await (0,u.E7)(d),p=l.filter(e=>e.email).length,m=l.filter(e=>e.phone_number).length;return n.Z.json({success:!0,message:"Live session started - Mass notifications triggered!",session:{session_id:t,location:s,playback_url:i,estimated_duration:r||120,started_at:a||new Date().toISOString(),stream_source:o},notifications:{active_codes:l.length,emails_scheduled:p,whatsapp_scheduled:m,make_automation_triggered:_,delivery_time:"\xeen maximum 2 minute"},automation:{webhook_sent:_,email_template:"Live Paranormal Started Notification",whatsapp_template:"Live Broadcast Alert",social_media:"Auto-post scheduled",analytics:"Event tracked"},recipients:l.map(e=>({email:e.email,phone:e.phone_number?"***"+e.phone_number.slice(-4):null,access_code:e.code,expires_in_hours:Math.floor((new Date(e.expires_at).getTime()-Date.now())/36e5)}))})}catch(e){return console.error("Error in live session started webhook:",e),n.Z.json({error:"Eroare internÄƒ server",message:"Nu s-au putut trimite notificÄƒrile pentru sesiunea LIVE"},{status:500})}}async function d(){try{let e=await (0,c.en)();return n.Z.json({service:"Live Session Started Webhook",status:"active",timestamp:new Date().toISOString(),ready_for_notifications:!0,current_active_codes:e.length,webhook_capabilities:{mass_email:!0,mass_whatsapp:!0,social_media_auto_post:!0,analytics_tracking:!0,make_com_automation:!0},templates:{email:"Live Paranormal Started - HTML with location and timing",whatsapp:"LIVE PARANORMAL ACUM! Quick notification with access link",social:"Instagram/Facebook auto-post with live details"},usage:{endpoint:"POST /api/webhooks/live-session-started",required_fields:["session_id","location","playback_url"],optional_fields:["estimated_duration","started_at","stream_source"]}})}catch(e){return console.error("Error checking live session webhook status:",e),n.Z.json({error:"Eroare la verificarea webhook-ului"},{status:500})}}let _=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/live-session-started/route",pathname:"/api/webhooks/live-session-started",filename:"route",bundlePath:"app/api/webhooks/live-session-started/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\plipli paranormal\\app\\api\\webhooks\\live-session-started\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:v,headerHooks:h,staticGenerationBailout:g}=_,E="/api/webhooks/live-session-started/route";function w(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},24522:(e,t,s)=>{s.d(t,{TC:()=>d,OF:()=>r,VT:()=>c,Xg:()=>a,en:()=>o,RG:()=>n,yj:()=>l,B6:()=>_,xL:()=>u});let i=new(require("pg")).Pool({connectionString:"postgresql://localhost:5432/plipli9_local"});async function r(e){return(await i.query(`INSERT INTO access_codes (code, email, phone_number, payment_intent_id, amount, payment_method, expires_at, status, usage_count, ip_address) 
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,[e.code,e.email,e.phone_number,e.payment_intent_id,e.amount,e.payment_method,e.expires_at,e.status,e.usage_count,e.ip_address])).rows[0]}async function a(e){let t=await i.query("SELECT * FROM access_codes WHERE code = $1 LIMIT 1",[e]);return t.rows.length>0?t.rows[0]:null}async function o(){return(await i.query("SELECT * FROM access_codes WHERE status = $1 AND expires_at > NOW()",["active"])).rows}async function n(){let e=await i.query("SELECT * FROM live_sessions WHERE status = $1 ORDER BY started_at DESC LIMIT 1",["active"]);return e.rows.length>0?e.rows[0]:null}async function c(e){await i.query("UPDATE live_sessions SET status = $1, ended_at = NOW() WHERE session_id = $2",["ended",e])}async function u(e){try{let t=e.trim().toUpperCase(),s=await i.query(`SELECT * FROM access_codes 
       WHERE code = $1 AND status = 'active' AND expires_at > CURRENT_TIMESTAMP`,[t]);if(0===s.rows.length)return null;return s.rows[0]}catch(e){return console.error("Eroare validare cod acces:",e),null}}async function l(e,t){try{let s=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await i.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP
       WHERE code = $3`,[s,JSON.stringify(t),e]),{success:!0,sessionId:s}}catch(e){throw console.error("Eroare pornire sesiune:",e),e}}async function d(e,t){try{let s=await i.query(`SELECT 
        active_session_id, 
        active_device_info, 
        session_started_at,
        status,
        expires_at
      FROM access_codes 
      WHERE code = $1`,[e]);if(0===s.rows.length)return{canAccess:!1,needsTakeover:!1,message:"Cod invalid sau expirat"};let r=s.rows[0];if(new Date>new Date(r.expires_at))return{canAccess:!1,needsTakeover:!1,message:"Cod expirat"};if(!r.active_session_id)return{canAccess:!0,needsTakeover:!1,message:"Cod disponibil pentru utilizare"};let a=r.active_device_info;if(a&&a.userAgent===t.userAgent&&a.ip===t.ip)return{canAccess:!0,needsTakeover:!1,message:"Sesiune existentÄƒ pe acelaÈ™i dispozitiv"};return{canAccess:!1,needsTakeover:!0,currentDevice:{userAgent:a?.userAgent||"Unknown",ip:a?.ip||"Unknown",connectedAt:r.session_started_at,sessionId:r.active_session_id},message:"Cod \xeen folosinÈ›Äƒ pe alt dispozitiv"}}catch(e){throw console.error("Eroare verificare sesiune:",e),e}}async function _(e,t){try{let s=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await i.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP,
         status = 'in_use',
         previous_sessions = previous_sessions || $3::jsonb
       WHERE code = $4`,[s,JSON.stringify(t),JSON.stringify([{...t,takenAt:new Date().toISOString(),action:"takeover"}]),e]),{success:!0,sessionId:s}}catch(e){throw console.error("Eroare takeover sesiune:",e),e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),i=t.X(0,[1638,6206,7257,1097,1209,3949,6454],()=>s(98346));module.exports=i})();