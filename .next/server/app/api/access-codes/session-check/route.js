"use strict";(()=>{var e={};e.id=8678,e.ids=[8678],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13812:(e,s,t)=>{t.r(s),t.d(s,{headerHooks:()=>v,originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>_,serverHooks:()=>E,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>T});var n={};t.r(n),t.d(n,{GET:()=>d,POST:()=>u});var r=t(95419),a=t(69108),i=t(99678),o=t(78070),c=t(24522);async function u(e){try{let s=await e.json();if(!s.code||!s.deviceInfo)return o.Z.json({error:"Cod și informații dispozitiv sunt obligatorii"},{status:400});let t=await (0,c.TC)(s.code,s.deviceInfo);return o.Z.json({success:!0,...t})}catch(e){return console.error("Eroare verificare sesiune:",e),o.Z.json({error:"Eroare internă server"},{status:500})}}async function d(){return o.Z.json({message:"Session check endpoint - use POST to check session conflicts"})}let _=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/access-codes/session-check/route",pathname:"/api/access-codes/session-check",filename:"route",bundlePath:"app/api/access-codes/session-check/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\plipli paranormal\\app\\api\\access-codes\\session-check\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:E,headerHooks:v,staticGenerationBailout:T}=_,y="/api/access-codes/session-check/route";function f(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:p})}},24522:(e,s,t)=>{t.d(s,{TC:()=>_,OF:()=>r,VT:()=>c,Xg:()=>a,en:()=>i,RG:()=>o,yj:()=>d,B6:()=>l,xL:()=>u});let n=new(require("pg")).Pool({connectionString:"postgresql://localhost:5432/plipli9_local"});async function r(e){return(await n.query(`INSERT INTO access_codes (code, email, phone_number, payment_intent_id, amount, payment_method, expires_at, status, usage_count, ip_address) 
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,[e.code,e.email,e.phone_number,e.payment_intent_id,e.amount,e.payment_method,e.expires_at,e.status,e.usage_count,e.ip_address])).rows[0]}async function a(e){let s=await n.query("SELECT * FROM access_codes WHERE code = $1 LIMIT 1",[e]);return s.rows.length>0?s.rows[0]:null}async function i(){return(await n.query("SELECT * FROM access_codes WHERE status = $1 AND expires_at > NOW()",["active"])).rows}async function o(){let e=await n.query("SELECT * FROM live_sessions WHERE status = $1 ORDER BY started_at DESC LIMIT 1",["active"]);return e.rows.length>0?e.rows[0]:null}async function c(e){await n.query("UPDATE live_sessions SET status = $1, ended_at = NOW() WHERE session_id = $2",["ended",e])}async function u(e){try{let s=e.trim().toUpperCase(),t=await n.query(`SELECT * FROM access_codes 
       WHERE code = $1 AND status = 'active' AND expires_at > CURRENT_TIMESTAMP`,[s]);if(0===t.rows.length)return null;return t.rows[0]}catch(e){return console.error("Eroare validare cod acces:",e),null}}async function d(e,s){try{let t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await n.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP
       WHERE code = $3`,[t,JSON.stringify(s),e]),{success:!0,sessionId:t}}catch(e){throw console.error("Eroare pornire sesiune:",e),e}}async function _(e,s){try{let t=await n.query(`SELECT 
        active_session_id, 
        active_device_info, 
        session_started_at,
        status,
        expires_at
      FROM access_codes 
      WHERE code = $1`,[e]);if(0===t.rows.length)return{canAccess:!1,needsTakeover:!1,message:"Cod invalid sau expirat"};let r=t.rows[0];if(new Date>new Date(r.expires_at))return{canAccess:!1,needsTakeover:!1,message:"Cod expirat"};if(!r.active_session_id)return{canAccess:!0,needsTakeover:!1,message:"Cod disponibil pentru utilizare"};let a=r.active_device_info;if(a&&a.userAgent===s.userAgent&&a.ip===s.ip)return{canAccess:!0,needsTakeover:!1,message:"Sesiune existentă pe același dispozitiv"};return{canAccess:!1,needsTakeover:!0,currentDevice:{userAgent:a?.userAgent||"Unknown",ip:a?.ip||"Unknown",connectedAt:r.session_started_at,sessionId:r.active_session_id},message:"Cod \xeen folosință pe alt dispozitiv"}}catch(e){throw console.error("Eroare verificare sesiune:",e),e}}async function l(e,s){try{let t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await n.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP,
         status = 'in_use',
         previous_sessions = previous_sessions || $3::jsonb
       WHERE code = $4`,[t,JSON.stringify(s),JSON.stringify([{...s,takenAt:new Date().toISOString(),action:"takeover"}]),e]),{success:!0,sessionId:t}}catch(e){throw console.error("Eroare takeover sesiune:",e),e}}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),n=s.X(0,[1638,6206],()=>t(13812));module.exports=n})();