"use strict";(()=>{var e={};e.id=3374,e.ids=[3374],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},16045:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>E});var s={};r.r(s),r.d(s,{GET:()=>p,POST:()=>l});var a=r(95419),i=r(69108),o=r(99678),n=r(78070),c=r(24522),u=r(6454);async function l(e){try{let t=await e.json();if(!t.email||!t.paymentMethod||!t.amount)return n.Z.json({error:"C\xe2mpurile email, paymentMethod și amount sunt obligatorii"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email))return n.Z.json({error:"Formatul email-ului este invalid"},{status:400});if(t.phone_number&&!/^\+?[1-9]\d{1,14}$/.test(t.phone_number.replace(/\s/g,"")))return n.Z.json({error:"Formatul numărului de WhatsApp este invalid"},{status:400});let r=()=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="PLI";for(let r=0;r<6;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},s=r();for(let e=0;e<3;e++)try{break}catch(t){if(2===e)throw t;s=r()}let a=new Date(Date.now()+288e5);await (0,c.OF)({code:s,email:t.email.trim().toLowerCase(),phone_number:t.phone_number?.trim()||void 0,payment_intent_id:t.paymentIntentId,amount:t.amount,payment_method:t.paymentMethod,expires_at:a,status:"active",usage_count:0,ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown"});let i="https://www.plipli9.com/live",o={accessCode:s,email:t.email.trim().toLowerCase(),phoneNumber:t.phone_number?.trim(),amount:t.amount,paymentMethod:t.paymentMethod,expiresAt:a.toISOString(),liveUrl:i,timestamp:new Date().toISOString()};console.log("\uD83D\uDE80 Triggering Make.com automation...");let l=await (0,u.$L)(o);return n.Z.json({success:!0,message:"Cod de acces creat cu succes",data:{accessCode:s,email:t.email.trim().toLowerCase(),expiresAt:a.toISOString(),validFor:"8 ore",liveUrl:i,features:["Acces flexibil - poți intra și ieși de c\xe2te ori vrei","Valabil 8 ore de la achiziție","Chat live cu alți participanți","Acces de pe orice device (telefon, tablet, computer)","Chiar dacă LIVE-ul se \xeentrerupe, codul răm\xe2ne valabil"]},notifications:{automation_triggered:l,email_scheduled:!0,whatsapp_scheduled:!!t.phone_number,delivery_time:"maximum 2 minute",note:l?"Notificările vor fi trimise automat via Make.com":"Notificările sunt programate pentru trimitere manuală"},next_steps:["\uD83D\uDCE7 Verifică email-ul pentru codul de acces",t.phone_number?"\uD83D\uDCF1 Verifică WhatsApp pentru confirmarea codului":"","\uD83C\uDF83 Mergi la pagina LIVE c\xe2nd primești notificarea","\uD83D\uDD13 Introdu codul pentru acces instant","\uD83D\uDC7B Bucură-te de experiența paranormală!"].filter(Boolean),support:{message:"Dacă nu primești codul \xeen 5 minute, contactează suportul",email:"suport@plipli9paranormal.com",whatsapp:"+40712345678"}})}catch(e){return console.error("Error creating access code:",e),n.Z.json({error:"Eroare la crearea codului de acces",message:e instanceof Error?e.message:"Eroare internă server",troubleshooting:["Verifică datele introduse","\xcencearcă din nou \xeen c\xe2teva secunde","Contactează suportul dacă problema persistă"]},{status:500})}}async function p(){return n.Z.json({service:"Plipli9 Access Code Generator",status:"active",timestamp:new Date().toISOString(),features:{database:"PlanetScale Cloud",automation:"Make.com",notifications:"Email + WhatsApp",validity:"8 hours flexible access"}})}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/access-codes/create/route",pathname:"/api/access-codes/create",filename:"route",bundlePath:"app/api/access-codes/create/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\plipli paranormal\\app\\api\\access-codes\\create\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:_,serverHooks:h,headerHooks:v,staticGenerationBailout:E}=d,f="/api/access-codes/create/route";function g(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},24522:(e,t,r)=>{r.d(t,{TC:()=>p,OF:()=>a,VT:()=>c,Xg:()=>i,en:()=>o,RG:()=>n,yj:()=>l,B6:()=>d,xL:()=>u});let s=new(require("pg")).Pool({connectionString:"postgresql://localhost:5432/plipli9_local"});async function a(e){return(await s.query(`INSERT INTO access_codes (code, email, phone_number, payment_intent_id, amount, payment_method, expires_at, status, usage_count, ip_address) 
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,[e.code,e.email,e.phone_number,e.payment_intent_id,e.amount,e.payment_method,e.expires_at,e.status,e.usage_count,e.ip_address])).rows[0]}async function i(e){let t=await s.query("SELECT * FROM access_codes WHERE code = $1 LIMIT 1",[e]);return t.rows.length>0?t.rows[0]:null}async function o(){return(await s.query("SELECT * FROM access_codes WHERE status = $1 AND expires_at > NOW()",["active"])).rows}async function n(){let e=await s.query("SELECT * FROM live_sessions WHERE status = $1 ORDER BY started_at DESC LIMIT 1",["active"]);return e.rows.length>0?e.rows[0]:null}async function c(e){await s.query("UPDATE live_sessions SET status = $1, ended_at = NOW() WHERE session_id = $2",["ended",e])}async function u(e){try{let t=e.trim().toUpperCase(),r=await s.query(`SELECT * FROM access_codes 
       WHERE code = $1 AND status = 'active' AND expires_at > CURRENT_TIMESTAMP`,[t]);if(0===r.rows.length)return null;return r.rows[0]}catch(e){return console.error("Eroare validare cod acces:",e),null}}async function l(e,t){try{let r=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await s.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP
       WHERE code = $3`,[r,JSON.stringify(t),e]),{success:!0,sessionId:r}}catch(e){throw console.error("Eroare pornire sesiune:",e),e}}async function p(e,t){try{let r=await s.query(`SELECT 
        active_session_id, 
        active_device_info, 
        session_started_at,
        status,
        expires_at
      FROM access_codes 
      WHERE code = $1`,[e]);if(0===r.rows.length)return{canAccess:!1,needsTakeover:!1,message:"Cod invalid sau expirat"};let a=r.rows[0];if(new Date>new Date(a.expires_at))return{canAccess:!1,needsTakeover:!1,message:"Cod expirat"};if(!a.active_session_id)return{canAccess:!0,needsTakeover:!1,message:"Cod disponibil pentru utilizare"};let i=a.active_device_info;if(i&&i.userAgent===t.userAgent&&i.ip===t.ip)return{canAccess:!0,needsTakeover:!1,message:"Sesiune existentă pe același dispozitiv"};return{canAccess:!1,needsTakeover:!0,currentDevice:{userAgent:i?.userAgent||"Unknown",ip:i?.ip||"Unknown",connectedAt:a.session_started_at,sessionId:a.active_session_id},message:"Cod \xeen folosință pe alt dispozitiv"}}catch(e){throw console.error("Eroare verificare sesiune:",e),e}}async function d(e,t){try{let r=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await s.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP,
         status = 'in_use',
         previous_sessions = previous_sessions || $3::jsonb
       WHERE code = $4`,[r,JSON.stringify(t),JSON.stringify([{...t,takenAt:new Date().toISOString(),action:"takeover"}]),e]),{success:!0,sessionId:r}}catch(e){throw console.error("Eroare takeover sesiune:",e),e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,7257,1097,1209,3949,6454],()=>r(16045));module.exports=s})();