"use strict";(()=>{var e={};e.id=3482,e.ids=[3482],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57147:e=>{e.exports=require("fs")},71017:e=>{e.exports=require("path")},95378:(e,s,t)=>{t.r(s),t.d(s,{headerHooks:()=>x,originalPathname:()=>C,patchFetch:()=>j,requestAsyncStorage:()=>A,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>v});var r={};t.r(r),t.d(r,{GET:()=>g,POST:()=>p});var a=t(95419),o=t(69108),n=t(99678),i=t(78070),c=t(57147),u=t.n(c),d=t(71017),l=t.n(d),m=t(95752);async function p(e){try{let s=(0,m.s$)(e),t=(0,m.Iy)(s,3,6e4);if(!t.allowed)return i.Z.json({success:!1,error:"Rate limit exceeded",message:"Prea multe \xeencercări de validare. \xcencearcă din nou peste 1 minut.",retryAfter:Math.ceil((t.resetTime-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":"3","X-RateLimit-Remaining":t.remaining.toString(),"X-RateLimit-Reset":t.resetTime.toString()}});let{accessCode:r,email:a}=await e.json();console.log("\uD83D\uDD11 VALIDATING ACCESS CODE:",r),console.log("\uD83D\uDCE7 For email:",a);let o=(0,m.CW)(r);if(!o.isValid)return i.Z.json({success:!1,error:"Invalid access code format",message:o.error},{status:400});let n=o.sanitized;if(a){if("string"!=typeof a)return i.Z.json({success:!1,error:"Invalid email format",message:"Email trebuie să fie text"},{status:400});if(a.trim().toLowerCase().length>254)return i.Z.json({success:!1,error:"Email too long",message:"Email prea lung (max 254 caractere)"},{status:400})}let c=l().join(process.cwd(),"data","payments.json");if(!u().existsSync(c))return i.Z.json({success:!1,error:"No payments database found"},{status:404});let d=u().readFileSync(c,"utf-8"),p=JSON.parse(d),g=p.find(e=>e.accessCode===n);if(!g)return console.log("❌ Access code not found:",n),i.Z.json({success:!1,error:"Invalid access code",message:"Codul de acces nu este valid sau nu există"},{status:404});if(a&&g.email!==a)return console.log("⚠️ Email mismatch for code:",n),i.Z.json({success:!1,error:"Email does not match access code",message:"Email-ul nu corespunde cu codul de acces"},{status:403});let f=new Date,A=new Date(g.expiresAt);if(f>A)return console.log("⏰ Access code expired:",n),i.Z.json({success:!1,error:"Access code expired",message:"Codul de acces a expirat",expiredAt:g.expiresAt},{status:410});if(g.usedAt){let e=new Date(g.usedAt).toLocaleString("ro-RO");return i.Z.json({success:!1,error:"Access code already used",message:`Codul a fost deja folosit la ${e}`,usedAt:g.usedAt},{status:409})}return g.usedAt=new Date().toISOString(),g.lastAccess={timestamp:new Date().toISOString(),ip:e.headers.get("x-forwarded-for")||"unknown",userAgent:e.headers.get("user-agent")||"unknown"},u().writeFileSync(c,JSON.stringify(p,null,2)),console.log("✅ Access granted for code:",n),i.Z.json({success:!0,message:"Access granted",accessGranted:!0,payment:{accessCode:g.accessCode,email:g.email,amount:g.amount,createdAt:g.createdAt,expiresAt:g.expiresAt,usedAt:g.usedAt},liveUrl:"https://www.plipli9.com/live",welcomeMessage:`Bun venit la transmisia LIVE paranormală! Codul tău ${n} este valid.`})}catch(e){return console.error("❌ Code validation error:",e),i.Z.json({success:!1,error:"Code validation failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function g(e){try{let s=new URL(e.url).searchParams.get("code");if(!s)return i.Z.json({success:!1,error:"Access code is required"},{status:400});let t=l().join(process.cwd(),"data","payments.json");if(!u().existsSync(t))return i.Z.json({success:!1,error:"No payments database found"},{status:404});let r=u().readFileSync(t,"utf-8"),a=JSON.parse(r).find(e=>e.accessCode===s);if(!a)return i.Z.json({success:!1,error:"Access code not found"},{status:404});let o=new Date,n=new Date(a.expiresAt),c=o>n,d=!!a.usedAt;return i.Z.json({success:!0,code:s,isValid:!c&&!d,isExpired:c,isUsed:d,expiresAt:a.expiresAt,usedAt:a.usedAt||null,status:d?"used":c?"expired":"valid"})}catch(e){return console.error("❌ Code check error:",e),i.Z.json({success:!1,error:"Code check failed"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/validate-code/route",pathname:"/api/validate-code",filename:"route",bundlePath:"app/api/validate-code/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\plipli paranormal\\app\\api\\validate-code\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:A,staticGenerationAsyncStorage:w,serverHooks:h,headerHooks:x,staticGenerationBailout:v}=f,C="/api/validate-code/route";function j(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},95752:(e,s,t)=>{function r(){let e=Date.now().toString(),s=Math.random().toString(36).substring(2,8).toUpperCase();return`PLI${e.slice(-3)}${s.slice(0,3)}`}function a(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}t.d(s,{Bm:()=>r,CW:()=>c,Iy:()=>n,s$:()=>i,vV:()=>a});let o=new Map;function n(e,s=5,t=6e4){let r=Date.now();Array.from(o.entries()).forEach(([e,s])=>{s.resetTime<r&&o.delete(e)});let a=o.get(e);return!a||a.resetTime<r?(o.set(e,{count:1,resetTime:r+t}),{allowed:!0,remaining:s-1,resetTime:r+t}):a.count>=s?{allowed:!1,remaining:0,resetTime:a.resetTime}:(a.count++,o.set(e,a),{allowed:!0,remaining:s-a.count,resetTime:a.resetTime})}function i(e){let s=e.headers.get("x-forwarded-for"),t=e.headers.get("x-real-ip"),r=e.headers.get("remote-addr"),a=s?.split(",")[0]?.trim()||t||r||"unknown",o=(e.headers.get("user-agent")||"unknown").substring(0,50);return`${a}:${o}`}function c(e){if("string"!=typeof e)return{isValid:!1,error:"Codul trebuie să fie string"};let s=e.trim().toUpperCase().replace(/[-\s]/g,"");return 0===s.length?{isValid:!1,error:"Cod de acces este obligatoriu"}:/^PLI\d{3}[A-Z]{3}$/.test(s)?{isValid:!0,sanitized:s}:{isValid:!1,error:"Format cod invalid (format așteptat: PLI123ABC)"}}}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[1638,6206],()=>t(95378));module.exports=r})();