"use strict";(()=>{var e={};e.id=7669,e.ids=[7669],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},23664:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>E,originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>g});var a={};s.r(a),s.d(a,{GET:()=>l,POST:()=>d});var i=s(95419),n=s(69108),r=s(99678),o=s(78070),c=s(24522),u=s(11144);async function d(e){try{let t;let{session_id:s,reason:a="manual_end"}=await e.json();if(s){let e=await (0,c.RG)();if(!e||e.session_id!==s)return o.Z.json({success:!1,error:"Sesiunea specificată nu este activă",message:"Session ID-ul nu corespunde cu sesiunea activă curentă"},{status:404});t=e}else{let e=await (0,c.RG)();if(!e)return o.Z.json({success:!1,error:"Nu există nicio sesiune activă de terminat",message:"Nu este pornit niciun LIVE \xeen acest moment"},{status:404});t=e}console.log(`🛑 Ending live session: ${t.session_id}`);let i={session_id:t.session_id,location:t.location,started_at:t.started_at,status:t.status,stream_key:t.stream_key,estimated_duration:t.estimated_duration},n=!1;try{await (0,u.vk)(t.session_id),n=!0,console.log("✅ Livepeer stream terminated successfully")}catch(e){console.error("❌ Error terminating Livepeer stream:",e)}await (0,c.VT)(t.session_id);let r=new Date(i.started_at),d=new Date,l=d.getTime()-r.getTime();return o.Z.json({success:!0,message:"Sesiunea LIVE a fost terminată cu succes",session:{session_id:i.session_id,location:i.location,started_at:i.started_at,ended_at:d.toISOString(),status:"ended",duration_minutes:Math.floor(l/6e4),reason:a},stream:{livepeer_terminated:n,stream_key:i.stream_key},impact:{message:"Codurile de acces răm\xe2n VALIDE",access_codes_status:"Utilizatorii pot intra din nou c\xe2nd pornești un nou LIVE",next_session:"Poți porni o nouă sesiune oric\xe2nd"},next_steps:["✅ Sesiunea curentă \xeenchisă","\uD83D\uDD04 Codurile de acces răm\xe2n active pentru 8h","\uD83C\uDFA5 Poți porni o nouă sesiune cu /api/live-sessions/start",'\uD83D\uDC65 Utilizatorii vor vedea "LIVE va \xeencepe \xeen cur\xe2nd"']})}catch(e){return console.error("Error ending live session:",e),o.Z.json({error:"Eroare internă server",message:"Nu s-a putut termina sesiunea LIVE"},{status:500})}}async function l(){try{let e=await (0,c.RG)();if(!e)return o.Z.json({active_session:null,can_end:!1,message:"Nu există nicio sesiune activă"});let t=new Date(e.started_at),s=new Date().getTime()-t.getTime();return o.Z.json({active_session:{session_id:e.session_id,location:e.location,started_at:e.started_at,status:e.status,estimated_duration:e.estimated_duration,current_duration_minutes:Math.floor(s/6e4),stream_key:e.stream_key},can_end:!0,endpoints:{end_current:"POST /api/live-sessions/end (no body)",end_specific:'POST /api/live-sessions/end {"session_id": "xxx"}'}})}catch(e){return console.error("Error getting session info for ending:",e),o.Z.json({error:"Eroare la verificarea sesiunilor"},{status:500})}}let _=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/live-sessions/end/route",pathname:"/api/live-sessions/end",filename:"route",bundlePath:"app/api/live-sessions/end/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\plipli paranormal\\app\\api\\live-sessions\\end\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:v,headerHooks:E,staticGenerationBailout:g}=_,y="/api/live-sessions/end/route";function w(){return(0,r.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},24522:(e,t,s)=>{s.d(t,{TC:()=>l,OF:()=>i,VT:()=>c,Xg:()=>n,en:()=>r,RG:()=>o,yj:()=>d,B6:()=>_,xL:()=>u});let a=new(require("pg")).Pool({connectionString:"postgresql://localhost:5432/plipli9_local"});async function i(e){return(await a.query(`INSERT INTO access_codes (code, email, phone_number, payment_intent_id, amount, payment_method, expires_at, status, usage_count, ip_address) 
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`,[e.code,e.email,e.phone_number,e.payment_intent_id,e.amount,e.payment_method,e.expires_at,e.status,e.usage_count,e.ip_address])).rows[0]}async function n(e){let t=await a.query("SELECT * FROM access_codes WHERE code = $1 LIMIT 1",[e]);return t.rows.length>0?t.rows[0]:null}async function r(){return(await a.query("SELECT * FROM access_codes WHERE status = $1 AND expires_at > NOW()",["active"])).rows}async function o(){let e=await a.query("SELECT * FROM live_sessions WHERE status = $1 ORDER BY started_at DESC LIMIT 1",["active"]);return e.rows.length>0?e.rows[0]:null}async function c(e){await a.query("UPDATE live_sessions SET status = $1, ended_at = NOW() WHERE session_id = $2",["ended",e])}async function u(e){try{let t=e.trim().toUpperCase(),s=await a.query(`SELECT * FROM access_codes 
       WHERE code = $1 AND status = 'active' AND expires_at > CURRENT_TIMESTAMP`,[t]);if(0===s.rows.length)return null;return s.rows[0]}catch(e){return console.error("Eroare validare cod acces:",e),null}}async function d(e,t){try{let s=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await a.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP
       WHERE code = $3`,[s,JSON.stringify(t),e]),{success:!0,sessionId:s}}catch(e){throw console.error("Eroare pornire sesiune:",e),e}}async function l(e,t){try{let s=await a.query(`SELECT 
        active_session_id, 
        active_device_info, 
        session_started_at,
        status,
        expires_at
      FROM access_codes 
      WHERE code = $1`,[e]);if(0===s.rows.length)return{canAccess:!1,needsTakeover:!1,message:"Cod invalid sau expirat"};let i=s.rows[0];if(new Date>new Date(i.expires_at))return{canAccess:!1,needsTakeover:!1,message:"Cod expirat"};if(!i.active_session_id)return{canAccess:!0,needsTakeover:!1,message:"Cod disponibil pentru utilizare"};let n=i.active_device_info;if(n&&n.userAgent===t.userAgent&&n.ip===t.ip)return{canAccess:!0,needsTakeover:!1,message:"Sesiune existentă pe același dispozitiv"};return{canAccess:!1,needsTakeover:!0,currentDevice:{userAgent:n?.userAgent||"Unknown",ip:n?.ip||"Unknown",connectedAt:i.session_started_at,sessionId:i.active_session_id},message:"Cod \xeen folosință pe alt dispozitiv"}}catch(e){throw console.error("Eroare verificare sesiune:",e),e}}async function _(e,t){try{let s=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return await a.query(`UPDATE access_codes 
       SET 
         active_session_id = $1,
         active_device_info = $2,
         session_started_at = CURRENT_TIMESTAMP,
         last_activity_at = CURRENT_TIMESTAMP,
         status = 'in_use',
         previous_sessions = previous_sessions || $3::jsonb
       WHERE code = $4`,[s,JSON.stringify(t),JSON.stringify([{...t,takenAt:new Date().toISOString(),action:"takeover"}]),e]),{success:!0,sessionId:s}}catch(e){throw console.error("Eroare takeover sesiune:",e),e}}},11144:(e,t,s)=>{s.d(t,{vk:()=>r,zy:()=>n});let a=new(s(31097)).Livepeer({apiKey:process.env.LIVEPEER_API_KEY||"demo-key"}),i=[{name:"1080p",bitrate:6e6,fps:30,width:1920,height:1080},{name:"720p",bitrate:3e6,fps:30,width:1280,height:720},{name:"480p",bitrate:15e5,fps:30,width:854,height:480},{name:"360p",bitrate:8e5,fps:30,width:640,height:360}];async function n(e="Plipli9 Paranormal Live"){try{let t=await a.stream.create({name:e,profiles:i.map(e=>({name:e.name,bitrate:e.bitrate,fps:e.fps,width:e.width,height:e.height,gop:"2.0"})),record:!0,multistream:{targets:[]}});if(!t.stream)throw Error("Failed to create stream");let s=t.stream;return{id:s.id||`stream_${Date.now()}`,name:s.name||e,streamKey:s.streamKey||`key_${Date.now()}`,rtmpIngestUrl:`rtmp://rtmp.livepeer.com/live/${s.streamKey||"default"}`,playbackId:s.playbackId||`playback_${Date.now()}`,playbackUrl:`https://lvpr.tv?v=${s.playbackId||"default"}`,status:"idle",isActive:!1,createdAt:s.createdAt?new Date(s.createdAt).toISOString():new Date().toISOString()}}catch(e){throw console.error("Error creating live stream:",e),Error("Failed to create live stream")}}async function r(e){try{return await a.stream.terminate(e),!0}catch(e){return console.error("Error terminating stream:",e),!1}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[1638,6206,1097],()=>s(23664));module.exports=a})();